<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Regional Attractiveness Model</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #020617;
      --panel: rgba(15, 23, 42, 0.9);
      --panel-strong: rgba(2, 6, 23, 0.75);
      --border: rgba(148, 163, 184, 0.25);
      --text: #f9fafb;
      --muted: #9ca3af;
      --accent-1: #d22730;
      --accent-2: #56c271;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; font-family: "Inter", sans-serif; background: var(--bg); color: var(--text); }
    #map { height: 100vh; width: 100vw; position: fixed; inset: 0; }

    /* Logo card */
    #logo-card { position: fixed; top: 16px; right: 18px; z-index: 4000; background: #f9fafb; border-radius: 16px; padding: 10px 14px; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 35px rgba(15,23,42,0.45); }
    #logo-card img { height: 32px; }
    #logo-card-text { display: flex; flex-direction: column; }
    #logo-card-title { font-size: 0.78rem; font-weight: 600; color: #111827; letter-spacing: 0.06em; text-transform: uppercase; }
    #logo-card-subtitle { font-size: 0.75rem; color: #4b5563; }

    /* Generic panels */
    .panel { position: relative; z-index: 3000; background: var(--panel); backdrop-filter: blur(16px); border-radius: 22px; box-shadow: 0 18px 45px rgba(0,0,0,0.6); border: 1px solid var(--border); }
    .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .panel-title { font-size: 0.95rem; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; color: #cbd5f5; }
    .panel-caption { font-size: 0.75rem; color: var(--muted); }
    .fold-toggle { font-size: 0.85rem; cursor: pointer; color: var(--muted); user-select: none; display: flex; align-items: center; gap: 4px; }
    .fold-toggle .chevron { display: inline-block; transition: transform 0.2s ease; }

    /* Sections */
    .section { margin-top: 10px; border-radius: 14px; background: rgba(15,23,42,0.8); padding: 10px 12px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .section-title { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); }
    .section-chevron { font-size: 0.75rem; opacity: 0.7; transition: transform 0.2s ease; }
    .section-body { margin-top: 8px; max-height: 1000px; overflow: hidden; transition: max-height 0.25s ease; }
    .section.collapsed .section-body { max-height: 0; }
    .section.collapsed .section-chevron { transform: rotate(-90deg); }

    /* Left stack */
    #left-stack { position: fixed; top: 16px; left: 16px; width: 360px; max-height: calc(100vh - 32px); display: flex; flex-direction: column; gap: 12px; padding-right: 6px; overflow-y: auto; z-index: 3500; }

    /* Control panel */
    #control-panel { width: 100%; padding: 18px 18px 14px 18px; }
    #control-content { margin-top: 4px; }
    .field-label { font-size: 0.75rem; color: var(--muted); margin-bottom: 4px; }
    select { width: 100%; padding: 8px 12px; border-radius: 12px; border: 1px solid #4b5563; background: var(--bg); color: #e5e7eb; font-size: 0.9rem; }

    /* Switch */
    .switch { position: relative; width: 46px; height: 24px; display: inline-block; }
    .switch input { display: none; }
    .slider { position: absolute; inset: 0; background: #4b5563; border-radius: 999px; cursor: pointer; transition: 0.25s; }
    .slider:before { content: ""; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px; background: #f9fafb; border-radius: 50%; transition: 0.25s; }
    .switch input:checked + .slider { background: #10b981; }
    .switch input:checked + .slider:before { transform: translateX(21px); }

    #hover-info { display: none; }

    /* Ranking panel */
    #ranking-panel { width: 100%; padding: 16px 16px 10px 16px; }
    #ranking-header-row { display: flex; justify-content: space-between; align-items: center; }
    #ranking-panel.collapsed #ranking-content { max-height: 0; }
    #ranking-panel.collapsed .fold-toggle .chevron { transform: rotate(-90deg); }
    .rank-tabs { display: inline-flex; border-radius: 999px; background: var(--bg); padding: 2px; margin-top: 6px; }
    .rank-tab { font-size: 0.75rem; padding: 3px 10px; border-radius: 999px; cursor: pointer; color: var(--muted); }
    .rank-tab.active { background: #0f172a; color: #e5e7eb; }
    #ranking-content { margin-top: 8px; max-height: 1000px; overflow: hidden; transition: max-height 0.25s ease; }
    .ranking-list { margin: 6px 0 0 0; padding: 0; list-style: none; }
    .ranking-item { padding: 7px 6px; border-radius: 10px; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; background: rgba(15,23,42,0.9); cursor: pointer; transition: background 0.18s, transform 0.18s; }
    .ranking-item:hover { background: #020617; transform: translateY(-1px); }
    .ranking-rank { font-weight: 600; margin-right: 6px; color: var(--muted); }
    .ranking-name { flex: 1; display: flex; flex-direction: column; }
    .ranking-sub { color: var(--muted); font-size: 0.72rem; }
    .ranking-value { font-weight: 600; font-size: 0.8rem; }

    /* Region analytics panel */
    #region-panel { position: fixed; right: 22px; top: 96px; bottom: 60px; width: min(calc(100vw - 700px), 520px); padding: 14px 16px; overflow: hidden; z-index: 3400; transition: transform 0.25s ease, opacity 0.2s ease; }
    #region-body { max-height: calc(100vh - 220px); overflow-y: auto; transition: opacity 0.2s ease; padding-right: 4px; }
    #region-panel.collapsed { transform: translateX(120%); opacity: 0; pointer-events: none; }
    #region-panel.collapsed .fold-toggle .chevron { transform: rotate(-90deg); }
    #region-title-main { font-size: 0.9rem; font-weight: 600; }
    #region-title-sub { font-size: 0.75rem; color: var(--muted); }

    .metric-scale-section { margin-top: 10px; }
    .metric-scale-label-row { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--muted); margin-bottom: 4px; }
    .metric-scale-bar { width: 100%; height: 12px; border-radius: 999px; background: linear-gradient(90deg, var(--accent-1), var(--accent-2)); position: relative; }
    .metric-scale-pointer { position: absolute; top: 50%; transform: translate(-50%,-50%); width: 2px; height: 16px; background: #f9fafb; box-shadow: 0 0 6px rgba(0,0,0,0.7); display: none; }
    .metric-scale-current { font-size: 0.75rem; color: #e5e7eb; margin-top: 4px; text-align: right; }

    .cluster-row { margin-top: 10px; }
    .cluster-label { font-size: 0.78rem; color: var(--muted); margin-bottom: 3px; }
    .cluster-bar-wrapper { width: 100%; height: 7px; border-radius: 999px; background: #020617; overflow: hidden; }
    .cluster-bar-fill { height: 100%; border-radius: 999px; background: linear-gradient(90deg, #ef4444, #22c55e); width: 0%; transition: width 0.3s ease; }
    .cluster-score { font-size: 0.75rem; color: #e5e7eb; margin-top: 2px; text-align: right; }

    /* Criteria tree */
    .criteria-row { margin-top: 10px; }
    .criteria-label { font-size: 0.78rem; color: var(--muted); margin-bottom: 4px; }
    .criteria-bar-wrapper { width: 100%; height: 7px; border-radius: 999px; background: #020617; overflow: hidden; }
    .criteria-bar-fill { height: 100%; border-radius: 999px; background: linear-gradient(90deg, #ef4444, #22c55e); width: 0%; transition: width 0.3s ease; }
    .criteria-score { font-size: 0.75rem; color: #e5e7eb; margin-top: 2px; text-align: right; }
    .criteria-group { margin-top: 10px; }
    .criteria-group-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 6px 0; }
    .criteria-group-title { font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: #cbd5f5; }
    .criteria-group-chevron { font-size: 0.75rem; opacity: 0.8; transition: transform 0.2s ease; }
    .criteria-group-body { margin-top: 6px; max-height: 1000px; overflow: hidden; transition: max-height 0.25s ease; }
    .criteria-group.collapsed .criteria-group-body { max-height: 0; }
    .criteria-group.collapsed .criteria-group-chevron { transform: rotate(-90deg); }
    .category-section { margin-bottom: 8px; padding: 8px; background: var(--panel-strong); border-radius: 10px; }
    .category-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 4px; }
    .category-title { font-size: 0.78rem; font-weight: 700; font-style: italic; color: #a5b4fc; }
    .category-chevron { font-size: 0.8rem; opacity: 0.8; transition: transform 0.2s ease; }
    .category-body { max-height: 1000px; overflow: hidden; transition: max-height 0.25s ease; }
    .category-section.collapsed .category-body { max-height: 0; }
    .category-section.collapsed .category-chevron { transform: rotate(-90deg); }
    .param-row { margin-bottom: 6px; }
    .param-row-top { display: flex; justify-content: space-between; font-size: 0.75rem; }
    .param-row-name { color: #e5e7eb; }
    .param-row-value { color: #e5e7eb; font-weight: 700; }
    .param-row-bar { margin-top: 3px; height: 5px; border-radius: 999px; background: #020617; overflow: hidden; }
    .param-row-bar-fill { height: 100%; border-radius: 999px; background: linear-gradient(90deg, #ef4444, #22c55e); width: 0%; transition: width 0.25s ease; }

    /* Buttons */
    .view-btn { border: 1px solid #4b5563; background: #0f172a; color: #e5e7eb; padding: 8px 10px; border-radius: 12px; cursor: pointer; font-size: 0.85rem; }
    .view-btn.active { background: #1f2937; border-color: #94a3b8; }

    #parameter-panel-section .section-body { display: block; }
    #parameter-panels { }
    .param-panel { display: none; background: var(--panel-strong); border-radius: 14px; padding: 10px; border: 1px solid var(--border); }
    .param-panel.active { display: block; }

    /* Metric detail drawer */
    #metric-detail-toggle { margin-top: 10px; display: inline-flex; align-items: center; gap: 6px; font-size: 0.85rem; }
    #metric-detail-card { display: none; margin-top: 8px; padding: 10px; border-radius: 12px; background: rgba(15,23,42,0.8); border: 1px solid var(--border); font-size: 0.82rem; line-height: 1.35; color: #e5e7eb; }
    #metric-detail-card .label { font-weight: 700; color: #cbd5f5; display: block; margin-bottom: 4px; }
    .param-panel-title { font-size: 0.85rem; font-weight: 700; letter-spacing: 0.05em; color: #cbd5f5; margin-bottom: 6px; }

    /* Snapshot */
    .metric-snapshot { margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .metric-box { background: #020617; border-radius: 12px; padding: 6px 8px; font-size: 0.8rem; }
    .metric-box-label { color: var(--muted); margin-bottom: 2px; }
    .metric-box-value { font-weight: 700; }

    /* Region footer panel */
    #region-footer-panel { position: fixed; right: 22px; bottom: 22px; width: 360px; padding: 12px 14px; z-index: 3400; }
    #region-footer-panel .panel-header { margin-bottom: 8px; }

    .map-label { color: #f9fafb; font-size: 0.85rem; font-weight: 700; text-shadow: 0 0 6px rgba(0,0,0,0.9); background: rgba(2,6,23,0.65); padding: 2px 6px; border-radius: 10px; border: 1px solid rgba(148,163,184,0.35); }
  </style>
</head>
<body>
  <div id="logo-card">
    <img id="logo-img" alt="DI Logo" style="height:32px;" />
    <div id="logo-card-text">
      <div id="logo-card-title">BHJ</div>
      <div id="logo-card-subtitle">Market Selection Model</div>
    </div>
  </div>

  <div id="left-stack">
    <div id="control-panel" class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Controls</div>
          <div class="panel-caption">Choose metric & value mode</div>
        </div>
        <div class="fold-toggle" id="control-fold-toggle"><span class="label">Hide</span><span class="chevron">▾</span></div>
      </div>
      <div id="control-content">
        <div class="section" id="section-mode">
          <div class="section-header"><div class="section-title">Value mode</div><div class="section-chevron">▾</div></div>
          <div class="section-body">
            <label style="display:flex;align-items:center;gap:10px;font-size:0.85rem;">
              <span>Raw</span>
              <label class="switch">
                <input type="checkbox" id="toggle-normalized" checked />
                <span class="slider"></span>
              </label>
              <span>Normalized</span>
            </label>
            <div class="panel-caption" style="margin-top:6px;">Toggle between normalized (0-100) and raw inputs.</div>
          </div>
        </div>
        <div class="section" id="section-view">
          <div class="section-header"><div class="section-title">View</div><div class="section-chevron">▾</div></div>
          <div class="section-body">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
              <button class="view-btn active" data-view="overview">Overview</button>
              <button class="view-btn" data-view="parameter">Parameter</button>
            </div>
            <div class="field-label">Metric selector</div>
            <select id="view-select"></select>
          </div>
        </div>
        <div class="field-label" style="margin-top:6px;">Hover info</div>
        <div id="hover-info">Hover over the country.</div>
      </div>
    </div>

    <div id="ranking-panel" class="panel">
      <div id="ranking-header-row">
        <div class="panel-title">Ranking</div>
        <div class="fold-toggle" id="ranking-fold-toggle"><span class="label">Hide</span><span class="chevron">▾</span></div>
      </div>
      <div id="ranking-caption" class="panel-caption">Click a country to zoom and load details</div>
      <div id="ranking-content"><ul id="ranking-list" class="ranking-list"></ul></div>
    </div>
  </div>

  <div id="region-panel" class="panel">
    <div class="panel-header">
      <div>
        <div id="region-title-main">No country selected</div>
        <div id="region-title-sub">Click on map or ranking to inspect a country</div>
      </div>
      <div class="fold-toggle" id="region-fold-toggle"><span class="label">Hide</span><span class="chevron">▾</span></div>
    </div>
    <div id="region-body">
      <div class="section" id="current-metric-section">
        <div class="section-header"><div class="section-title">Current metric</div><div class="section-chevron">▾</div></div>
        <div class="section-body">
          <div class="metric-scale-label-row"><span id="current-metric-label">None</span><span id="metric-scale-mode-label">Normalized 0-100</span></div>
          <div class="metric-scale-bar" id="region-metric-scale-bar"><div class="metric-scale-pointer" id="region-metric-scale-pointer"></div></div>
          <div class="metric-scale-current" id="region-metric-scale-current">No country selected.</div>
          <button id="metric-detail-toggle" class="view-btn" aria-expanded="false">Show metric details</button>
          <div id="metric-detail-card">
            <span class="label">Description</span>
            <div id="metric-detail-desc">Not available.</div>
            <span class="label" style="margin-top:6px;">Justification</span>
            <div id="metric-detail-just">Not available.</div>
          </div>
        </div>
      </div>

      <div class="section" id="overview-section">
        <div class="section-header"><div class="section-title">Overview (total & composites)</div><div class="section-chevron">▾</div></div>
        <div class="section-body">
          <div class="cluster-row">
            <div class="cluster-label">Total score</div>
            <div class="cluster-bar-wrapper"><div id="composite-bar" class="cluster-bar-fill"></div></div>
            <div id="composite-score" class="cluster-score">N/A</div>
          </div>
          <div id="criteria-scores-container"></div>
        </div>
      </div>

      <div class="section" id="parameter-panel-section">
        <div class="section-header"><div class="section-title">Parameters by pillar</div><div class="section-chevron">▾</div></div>
        <div class="section-body" id="parameter-panels-wrapper">
          <div id="pillar-tabs" style="display:flex;gap:8px;margin-bottom:8px;">
            <button class="view-btn pillar-btn active" data-pillar="market">Market</button>
            <button class="view-btn pillar-btn" data-pillar="talent">Talent</button>
            <button class="view-btn pillar-btn" data-pillar="costs">Costs</button>
          </div>
          <div id="parameter-panels"></div>
        </div>
      </div>
    </div>
  </div>
  <button id="details-toggle" class="view-btn" style="position:fixed;right:12px;top:96px;z-index:3500;display:none;">Details</button>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    "use strict";
    const criteriaStructure = [
      {
        id: "market",
        label: "Market Characteristics",
        weight: 40,
        categories: [
          {
            id: "business_regulatory",
            label: "Business & regulatory environment",
            weight: 25,
            parameters: [
              { key: "ease_business", label: "Ease of doing business", weight: 30 },
              { key: "employment_protection", label: "Strictness of employment protection", weight: 40 },
              { key: "remote_meeting_norm", label: "Remote meeting norm", weight: 30 }
            ]
          },
          {
            id: "connectivity",
            label: "Infrastructure & geographic connectivity",
            weight: 35,
            parameters: [
              { key: "flight_connectivity", label: "Flight connectivity (number of direct routes)", weight: 30 },
              { key: "transport_infra", label: "Transport infrastructure (quality of national infrastructure)", weight: 70 }
            ]
          },
          {
            id: "workforce_loyalty",
            label: "Workforce stability and loyalty",
            weight: 40,
            parameters: [
              { key: "employment_flexibility", label: "Employment flexibility", weight: 10 },
              { key: "job_loyalty", label: "Job loyalty (>5 years in job tenure)", weight: 35 },
              { key: "job_switching", label: "Job switching rate (12 months or less)", weight: 35 },
              { key: "self_employed", label: "Percentage self employed (freelance tendency)", weight: 20 }
            ]
          }
        ]
      },
      {
        id: "talent",
        label: "Talent Attractiveness",
        weight: 40,
        categories: [
          {
            id: "access_talent",
            label: "Access to talent",
            weight: 40,
            parameters: [
              { key: "ict_workforce", label: "ICT personnel (tertiary education) workforce size", weight: 28 },
              { key: "skill_shortage", label: "Skill shortage (% enterprises with hard-to-fill vacancies ICT)", weight: 28 },
              { key: "ict_graduates", label: "ICT graduates as % of total graduates", weight: 25 },
              { key: "ict_unemployment", label: "Unemployment rate (have ICT education)", weight: 15 }
            ]
          },
          {
            id: "talent_quality",
            label: "Talent quality",
            weight: 40,
            parameters: [
              { key: "ict_distribution_35_74", label: "Distribution of employed persons with ICT education aged 35-74", weight: 15 },
              { key: "ict_tertiary_share", label: "Share of ICT specialists with tertiary education", weight: 35 },
              { key: "digital_experts", label: "Digital experts (% of employees who are digital experts)", weight: 15 },
              { key: "labor_productivity", label: "Labor productivity (ICT)", weight: 35 }
            ]
          },
          {
            id: "cultural_fit",
            label: "Cultural fit",
            weight: 20,
            parameters: [
              { key: "english_capabilities", label: "English capabilities", weight: 50 },
              { key: "cultural_distance", label: "Cultural distance (Kogut-Singh index)", weight: 50 }
            ]
          }
        ]
      },
      {
        id: "costs",
        label: "Costs",
        weight: 20,
        categories: [
          {
            id: "salary",
            label: "Salary",
            weight: 100,
            parameters: [
              { key: "salary_level", label: "Salary level EUR (IT personnel)", weight: 40 },
              { key: "salary_growth", label: "Forecasted salary growth in % (2031, IT personnel)", weight: 60 }
            ]
          }
        ]
      }
    ];

    const allParameters = [];
    criteriaStructure.forEach(c => c.categories.forEach(cat => cat.parameters.forEach(p => allParameters.push({ key: p.key, label: p.label, criteriaId: c.id, categoryId: cat.id }))));
    const compositeMetrics = [
      { key: "composite_overall", label: "Total score" },
      { key: "composite_market", label: "Market characteristics (Composite)" },
      { key: "composite_talent", label: "Talent attractiveness (Composite)" },
      { key: "composite_costs", label: "Cost advantages (Composite)" }
    ];
    const allMetrics = [...compositeMetrics, ...allParameters];
    const paramMeta = {
      ease_business: {
        desc: "Ease of starting, operating and scaling a business based on regulatory framework and administrative processes.",
        just: "Rigorous and widely accepted measure of the complexity of doing business in a given country."
      },
      employment_protection: {
        desc: "Strictness of employment protection (weighted sum of 23 sub-indicators) on a 0-6 scale.",
        just: "Employment strictness dictates the flexibility in terminating employments."
      },
      remote_meeting_norm: {
        desc: "Percent of enterprises conducting remote meetings.",
        just: "Higher share suggests remote work is common and attractive when work is primarily remote."
      },
      flight_connectivity: {
        desc: "Number of direct flights (excluding holiday destinations) from Denmark.",
        just: "Direct routes capture how well-connected the host country is to Denmark."
      },
      transport_infra: {
        desc: "Average score of 8 indicators influencing transport infrastructure (roads, rail, efficiency, etc.).",
        just: "Better infrastructure expands hiring radius and eases visits."
      },
      employment_flexibility: {
        desc: "Measures hiring regulations, work hours, costs; higher value = more flexible employment rules.",
        just: "Higher flexibility can imply less stability for the firm."
      },
      job_loyalty: {
        desc: "Job tenure distribution (EU LFS) for employed persons.",
        just: "Indicates job loyalty via duration in current roles."
      },
      job_switching: {
        desc: "Share of ICT specialists new in their job (< 12 months).",
        just: "Higher share signals more mobility and lower long-term loyalty."
      },
      self_employed: {
        desc: "Percent of ICT specialists who are self-employed.",
        just: "Reflects strength of freelance culture within ICT."
      },
      ict_workforce: {
        desc: "Total number of ICT specialists with tertiary education.",
        just: "Captures depth of highly educated ICT talent available."
      },
      skill_shortage: {
        desc: "Enterprises that recruited ICT specialists with difficulties (%).",
        just: "Higher values indicate tighter talent markets and harder access."
      },
      ict_graduates: {
        desc: "ICT graduates as percent of total graduates.",
        just: "Shows how much the education system produces ICT-specific skills."
      },
      ict_unemployment: {
        desc: "Unemployment rate among ICT specialists.",
        just: "Higher unemployment suggests greater immediate availability of ICT talent."
      },
      ict_distribution_35_74: {
        desc: "Distribution of employed persons with ICT education aged 35-74.",
        just: "Higher share implies more experience and potentially higher quality output."
      },
      ict_tertiary_share: {
        desc: "Distribution of employed persons with ICT education by educational attainment (tertiary) in 2024.",
        just: "Measures percentage with tertiary ICT education in target countries."
      },
      digital_experts: {
        desc: "% of employees who are digital experts (OECD/ESCO-defined advanced ICT roles).",
        just: "Captures prevalence of advanced digital talent beyond basic skills."
      },
      labor_productivity: {
        desc: "Labour productivity (real) per hour worked in information and communication industry.",
        just: "Measures output per hour for ICT sector workers."
      },
      english_capabilities: {
        desc: "EF English Proficiency Index score.",
        just: "Based on 2.2M test takers incl. speaking/writing, broader view of English skills."
      },
      cultural_distance: {
        desc: "Cultural distance index (Hofstede dimensions; Konara & Mohr Euclidean distance).",
        just: "Best available quantitative measure of cultural distance to Denmark."
      },
      salary_level: {
        desc: "Average base salary for senior IT specialists (EUR).",
        just: "Captures salary level for senior IT personnel converted to EUR."
      },
      salary_growth: {
        desc: "% change in hourly wage YoY (2024-2025).",
        just: "Captures recent wage growth in target countries."
      }
    };
    const invertMetrics = new Set([
      "employment_protection",
      "employment_flexibility",
      "job_switching",
      "skill_shortage",
      "cultural_distance",
      "salary_level",
      "salary_growth"
    ]);

    let showNormalized = true;
    let currentMetric = "composite_overall";
    let currentView = "overview"; // "overview" | "parameter"
    let currentCountryProps = null;

    const map = L.map("map", { zoomControl: false }).setView([50, 15], 4.5);
    L.control.zoom({ position: "bottomright" }).addTo(map);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "", opacity: 0.35 }).addTo(map);

    let geoLayer = null;
    let activeLayer = null;
    let rawLabelLayer = L.layerGroup().addTo(map);
    const countryLayerByName = {};
    const metricExtents = {};
    const paramBarEls = {};
    const paramValueEls = {};

    const countryNames = ["Germany", "Hungary", "Lithuania", "Poland", "Spain", "Portugal", "Slovakia", "Czechia"];

    const rawRows = [
      [79.70, 73.40, 81.60, 76.40, 77.90, 76.50, 75.60, 76.30],
      [2.33, 1.89, 2.24, 2.39, 2.43, 2.87, 2.33, 3.03],
      [61.00, 33.50, 42.10, 46.90, 55.10, 53.90, 39.10, 46.60],
      [7.00, 1.00, 3.00, 6.00, 6.00, 4.00, 2.00, 1.00],
      [84.30, 66.00, 59.20, 67.80, 83.60, 71.20, 59.50, 70.50],
      [63.50, 72.50, 70.30, 60.70, 60.80, 45.50, 48.20, 80.30],
      [58.70, 58.60, 57.30, 62.30, 57.30, 61.40, 68.80, 64.90],
      [16.50, 13.80, 13.70, 10.70, 20.10, 15.70, 8.50, 10.20],
      [8.5, 18.4, 9.5, 27.6, 9.9, 9.2, 17.0, 25.6],
      [452000, 47200, 24700, 225200, 416300, 30500, 24100, 50100],
      [72.41, 62.43, 47.01, 32.25, 30.15, 50.52, 53.12, 70.47],
      [5.10, 5.70, 4.70, 4.10, 4.80, 2.50, 4.40, 5.50],
      [3.40, 4.20, 6.70, 4.10, 9.90, 9.60, 2.90, 2.80],
      [35.70, 23.90, 35.70, 25.00, 31.20, 25.00, 26.70, 23.90],
      [69.70, 65.40, 90.40, 62.50, 84.90, 38.30, 73.40, 64.70],
      [5.30, 4.50, 5.30, 4.50, 4.70, 5.20, 4.60, 4.30],
      [115.48, 141.99, 94.58, 113.57, 98.85, 87.93, 99.17, 139.88],
      [615.00, 590.00, 543.00, 600.00, 540.00, 612.00, 606.00, 582.00],
      [3.57, 5.71, 5.53, 6.49, 4.88, 6.32, 6.47, 4.92],
      [77620, 23205, 27796, 34233, 45211, 38432, 34164, 34859],
      [12.00, 42.00, 38.00, 51.00, 13.00, 11.00, 23.00, 18.00]
    ];

    const normRows = [
      [79.70, 73.40, 81.60, 76.40, 77.90, 76.50, 75.60, 76.30],
      [61.17, 68.50, 62.67, 60.17, 59.50, 52.17, 61.17, 49.50],
      [61.00, 33.50, 42.10, 46.90, 55.10, 53.90, 39.10, 46.60],
      [100.00, 14.29, 42.86, 85.71, 85.71, 57.14, 28.57, 14.29],
      [84.30, 66.00, 59.20, 67.80, 83.60, 71.20, 59.50, 70.50],
      [36.50, 27.50, 29.70, 39.30, 39.20, 54.50, 51.80, 19.70],
      [58.70, 58.60, 57.30, 62.30, 57.30, 61.40, 68.80, 64.90],
      [31.03, 54.31, 55.17, 81.03, 0.00, 37.93, 100.00, 85.34],
      [100.00, 48.17, 94.76, 0.00, 92.67, 96.34, 55.50, 10.47],
      [100.00, 9.14, 4.09, 49.09, 91.99, 5.39, 3.95, 9.79],
      [27.59, 37.57, 52.99, 67.75, 69.85, 49.48, 46.88, 29.53],
      [51.00, 57.00, 47.00, 41.00, 48.00, 25.00, 44.00, 55.00],
      [8.45, 19.72, 54.93, 18.31, 100.00, 95.77, 1.41, 0.00],
      [100.00, 0.00, 100.00, 9.32, 61.86, 9.32, 23.73, 0.00],
      [69.70, 65.40, 90.40, 62.50, 84.90, 38.30, 73.40, 64.70],
      [100.00, 20.00, 100.00, 20.00, 40.00, 90.00, 30.00, 0.00],
      [50.96, 100.00, 12.30, 47.43, 20.20, 0.00, 20.79, 96.09],
      [90.46, 82.24, 66.78, 85.53, 65.79, 89.47, 87.50, 79.61],
      [100.00, 26.72, 32.64, 0.00, 55.11, 5.67, 0.59, 53.83],
      [0.00, 100.00, 91.56, 79.73, 59.56, 72.02, 79.86, 78.58],
      [97.50, 22.50, 32.50, 0.00, 95.00, 100.00, 70.00, 82.50]
    ];

    const compositeMarket = [69.8, 53.3, 59.1, 62.5, 62.4, 62.2, 62.4, 55.6];
    const compositeTalent = [68.9, 47.7, 51.2, 44.9, 63.1, 35.7, 35.8, 46.1];
    const compositeCosts = [48.8, 61.3, 62.0, 39.9, 77.3, 86.0, 74.9, 80.5];
    const compositeTotal = [65.2, 52.7, 56.5, 50.9, 65.7, 56.4, 54.3, 56.8];

    const countryData = {};
    let currentPillar = "market";
    countryNames.forEach((name, idx) => {
      const props = { name };
      allParameters.forEach((param, pIdx) => {
        props[`${param.key}_raw`] = rawRows[pIdx][idx];
        props[`${param.key}_norm`] = normRows[pIdx][idx];
      });
      props.composite_market_norm = compositeMarket[idx];
      props.composite_talent_norm = compositeTalent[idx];
      props.composite_costs_norm = compositeCosts[idx];
      props.composite_overall_norm = compositeTotal[idx];
      props.composite_market_raw = compositeMarket[idx];
      props.composite_talent_raw = compositeTalent[idx];
      props.composite_costs_raw = compositeCosts[idx];
      props.composite_overall_raw = compositeTotal[idx];
      countryData[name] = props;
    });

    const formatValue = v => typeof v === "number" && isFinite(v) ? v.toFixed(1) : "N/A";
    const clamp01 = v => Math.max(0, Math.min(1, v));
    const getColor = t => { const r = Math.round(210 + t * (86 - 210)); const g = Math.round(39 + t * (194 - 39)); const b = Math.round(48 + t * (113 - 48)); return `rgb(${r},${g},${b})`; };

    function ensureMetricForMode() {
      if (!showNormalized && currentMetric.startsWith("composite_")) {
        currentMetric = allParameters[0]?.key || "composite_overall";
      }
      if (currentView === "overview" && !currentMetric.startsWith("composite_")) {
        currentMetric = "composite_overall";
      }
    }

    function styleCountry(f) {
      const props = (f && f.properties) || {};
      const field = `${currentMetric}_${showNormalized ? "norm" : "raw"}`;
      const value = props[field];
      let fillColor = "#020617";
      if (typeof value === "number" && showNormalized) {
        fillColor = getColor(clamp01(value / 100));
      }
      return {
        fillColor,
        fillOpacity: showNormalized ? 0.88 : 0.5,
        color: showNormalized ? "#0f172a" : "#94a3b8",
        weight: showNormalized ? 1.4 : 1.8
      };
    }

    function updateLegendPointer(value) { /* legend removed */ }

    function setActiveCountryLayer(layer) {
      if (activeLayer) activeLayer.setStyle(styleCountry(activeLayer.feature));
      activeLayer = layer;
      if (layer) { layer.setStyle({ ...styleCountry(layer.feature), weight: 2.4, color: "#e5e7eb" }); if (layer.bringToFront) layer.bringToFront(); }
    }

    function buildCriteriaUI() {
      const scores = document.getElementById("criteria-scores-container");
      const panels = document.getElementById("parameter-panels");
      scores.innerHTML = "";
      panels.innerHTML = "";
      criteriaStructure.forEach(criteria => {
        const scoreRow = document.createElement("div");
        scoreRow.className = "criteria-row";
        scoreRow.innerHTML = `
          <div class="criteria-label">${criteria.label}</div>
          <div class="criteria-bar-wrapper"><div class="criteria-bar-fill" id="criteria-bar-${criteria.id}"></div></div>
          <div class="criteria-score" id="criteria-score-${criteria.id}">N/A</div>
        `;
        scores.appendChild(scoreRow);

        const panel = document.createElement("div");
        panel.className = "param-panel";
        panel.dataset.pillar = criteria.id;
        panel.innerHTML = `<div class="param-panel-title">${criteria.label}</div>`;
        criteria.categories.forEach(cat => {
          const catDiv = document.createElement("div");
          catDiv.className = "category-section";
          const catHeader = document.createElement("div");
          catHeader.className = "category-header";
          catHeader.innerHTML = `<div class="category-title">${cat.label}</div><div class="category-chevron">v</div>`;
          const catBody = document.createElement("div");
          catBody.className = "category-body";
          cat.parameters.forEach(param => {
            const row = document.createElement("div");
            row.className = "param-row";
            row.innerHTML = `
              <div class="param-row-top">
                <span class="param-row-name">${param.label}</span>
                <span class="param-row-value" id="param-value-${param.key}">N/A</span>
              </div>
              <div class="param-row-bar"><div class="param-row-bar-fill" id="param-bar-${param.key}"></div></div>
            `;
            catBody.appendChild(row);
            paramBarEls[param.key] = row.querySelector(`#param-bar-${param.key}`);
            paramValueEls[param.key] = row.querySelector(`#param-value-${param.key}`);
          });
          catDiv.appendChild(catHeader);
          catDiv.appendChild(catBody);
          panel.appendChild(catDiv);
          catHeader.addEventListener("click", () => catDiv.classList.toggle("collapsed"));
        });
        panels.appendChild(panel);
      });
    }

    function computeMetricExtents(data) {
      allParameters.forEach(param => {
        let min = Infinity, max = -Infinity;
        data.features.forEach(f => {
          const v = f.properties[`${param.key}_raw`];
          if (typeof v === "number") { min = Math.min(min, v); max = Math.max(max, v); }
        });
        metricExtents[param.key] = { min, max };
      });
    }

    const labelCenters = {
      Spain: [40.0, -3.7],
      Portugal: [39.5, -8.0]
    };

    function updateRawLabels() {
      rawLabelLayer.clearLayers();
      if (!geoLayer || showNormalized) return;
      const field = `${currentMetric}_raw`;
      geoLayer.eachLayer(l => {
        const val = l.feature.properties[field];
        const name = l.feature.properties.name;
        const baseCenter = labelCenters[name] ? L.latLng(labelCenters[name][0], labelCenters[name][1]) : l.getBounds().getCenter();
        const txt = typeof val === "number" ? formatValue(val) : "N/A";
        const marker = L.marker(baseCenter, {
          interactive: false,
          icon: L.divIcon({ className: "map-label", html: txt })
        });
        rawLabelLayer.addLayer(marker);
      });
    }

    function updateMap() {
      if (!geoLayer) return;
      geoLayer.eachLayer(l => l.setStyle(styleCountry(l.feature)));
      updateRawLabels();
      if (activeLayer) setActiveCountryLayer(activeLayer);
    }

    const getAllFeatureProps = () => geoLayer ? geoLayer.getLayers().map(l => l.feature.properties) : [];

    function rebuildViewSelect() {
      const sel = document.getElementById("view-select");
      sel.innerHTML = "";
      const addOptGroup = (label, items) => {
        const grp = document.createElement("optgroup");
        grp.label = label;
        items.forEach(m => {
          if (!showNormalized && m.key.startsWith("composite_")) return;
          const opt = document.createElement("option");
          opt.value = m.key;
          opt.textContent = m.label;
          grp.appendChild(opt);
        });
        if (grp.children.length) sel.appendChild(grp);
      };

      if (currentView === "overview") {
        addOptGroup("Composites", compositeMetrics);
      } else {
        addOptGroup("Composites", compositeMetrics);
        criteriaStructure.forEach(c => {
          const items = [];
          c.categories.forEach(cat => {
            cat.parameters.forEach(p => items.push({ key: p.key, label: `${c.label} · ${cat.label} · ${p.label}` }));
          });
          addOptGroup(c.label, items);
        });
      }

      let hasCurrent = [...sel.options].some(o => o.value === currentMetric);
      if (hasCurrent) sel.value = currentMetric;
      else if (sel.options.length) {
        sel.selectedIndex = 0;
        currentMetric = sel.value;
      }
    }

    function buildHeatmapSelect() {
      const sel = document.getElementById("view-select");
      sel.innerHTML = "";
      const addOptGroup = (label, items) => {
        const grp = document.createElement("optgroup");
        grp.label = label;
        items.forEach(m => {
          if (!showNormalized && m.key.startsWith("composite_")) return;
          const opt = document.createElement("option");
          opt.value = m.key;
          opt.textContent = m.label;
          grp.appendChild(opt);
        });
        if (grp.children.length) sel.appendChild(grp);
      };
      if (currentView === "overview") {
        addOptGroup("Composites", compositeMetrics);
      } else {
        addOptGroup("Composites", compositeMetrics);
        criteriaStructure.forEach(c => {
          const items = [];
          c.categories.forEach(cat => {
            cat.parameters.forEach(p => items.push({ key: p.key, label: `${c.label} · ${cat.label} · ${p.label}` }));
          });
          addOptGroup(c.label, items);
        });
      }

      if (![...sel.options].some(o => o.value === currentMetric)) {
        sel.selectedIndex = 0;
        currentMetric = sel.value || currentMetric;
      } else {
        sel.value = currentMetric;
      }
    }

    function setViewMode(view) {
      currentView = view;
      document.querySelectorAll(".view-btn").forEach(b => b.classList.toggle("active", b.dataset.view === view));
      document.getElementById("overview-section").style.display = view === "overview" ? "block" : "none";
      document.getElementById("parameter-panel-section").style.display = view === "overview" ? "none" : "block";
      rebuildViewSelect();
      buildHeatmapSelect();
      updateMap();
      updateRanking();
      if (currentCountryProps) updateRegionPanel(currentCountryProps);
    }

    function updateRanking() {
      const list = document.getElementById("ranking-list");
      list.innerHTML = "";
      const field = `${currentMetric}_${showNormalized ? "norm" : "raw"}`;
      const metricLabel = allMetrics.find(m => m.key === currentMetric)?.label || currentMetric;
      const caption = document.getElementById("ranking-caption");
      if (caption) caption.textContent = `Ranking by ${metricLabel} (${showNormalized ? "normalized" : "raw"})`;
      const sorted = getAllFeatureProps().sort((a, b) => {
        const va = a[field];
        const vb = b[field];
        const aEff = showNormalized ? va : invertMetrics.has(currentMetric) ? (typeof va === "number" ? -va : -Infinity) : va;
        const bEff = showNormalized ? vb : invertMetrics.has(currentMetric) ? (typeof vb === "number" ? -vb : -Infinity) : vb;
        return (bEff ?? -Infinity) - (aEff ?? -Infinity);
      });
      sorted.forEach((props, idx) => {
        const li = document.createElement("li");
        li.className = "ranking-item";
        li.dataset.name = props.name;
        li.innerHTML = `
          <span class="ranking-rank">#${idx + 1}</span>
          <span class="ranking-name">
            <span>${props.name}</span>
            <span class="ranking-sub">${metricLabel}</span>
          </span>
          <span class="ranking-value">${formatValue(props[field])}</span>
        `;
        li.addEventListener("click", () => {
          const layer = countryLayerByName[props.name];
          if (layer) {
            const center = layer.getBounds().getCenter();
            map.flyTo(center, 6, { duration: 0.8 });
            setActiveCountryLayer(layer);
            updateRegionPanel(props);
          }
        });
        list.appendChild(li);
      });
    }

    function updateRegionPanel(props) {
      currentCountryProps = props || null;
      const titleMain = document.getElementById("region-title-main");
      const titleSub = document.getElementById("region-title-sub");
      const scalePointer = document.getElementById("region-metric-scale-pointer");
      const scaleCurrent = document.getElementById("region-metric-scale-current");
      const compositeBar = document.getElementById("composite-bar");
      const compositeScoreEl = document.getElementById("composite-score");
      const detailCard = document.getElementById("metric-detail-card");
      const detailToggle = document.getElementById("metric-detail-toggle");
      const detailDesc = document.getElementById("metric-detail-desc");
      const detailJust = document.getElementById("metric-detail-just");

      if (!props) {
        titleMain.textContent = "No country selected";
        titleSub.textContent = "Click on map or ranking to inspect a country";
        Object.values(paramBarEls).forEach(el => (el.style.width = "0%"));
        Object.values(paramValueEls).forEach(el => (el.textContent = "N/A"));
        criteriaStructure.forEach(c => { document.getElementById(`criteria-bar-${c.id}`).style.width = "0%"; document.getElementById(`criteria-score-${c.id}`).textContent = "N/A"; });
        compositeBar.style.width = "0%"; compositeScoreEl.textContent = "N/A";
        scalePointer.style.display = "none"; scaleCurrent.textContent = "No country selected.";
        if (detailCard) detailCard.style.display = "none";
        return;
      }

      titleMain.textContent = props.name;
      titleSub.textContent = "Metric profile & composite scores";

      if (typeof props.composite_overall_norm === "number") {
        compositeBar.style.width = `${clamp01(props.composite_overall_norm / 100) * 100}%`;
        compositeScoreEl.textContent = formatValue(props.composite_overall_norm);
      } else { compositeBar.style.width = "0%"; compositeScoreEl.textContent = "N/A"; }

      criteriaStructure.forEach(c => {
        const val = props[`composite_${c.id}_norm`];
        const bar = document.getElementById(`criteria-bar-${c.id}`);
        const score = document.getElementById(`criteria-score-${c.id}`);
        if (typeof val === "number") { bar.style.width = `${clamp01(val / 100) * 100}%`; score.textContent = formatValue(val); }
        else { bar.style.width = "0%"; score.textContent = "N/A"; }
      });

      allParameters.forEach(param => {
        const field = `${param.key}_${showNormalized ? "norm" : "raw"}`;
        const v = props[field];
        const valueEl = paramValueEls[param.key];
        const barEl = paramBarEls[param.key];
        if (valueEl) valueEl.textContent = formatValue(v);
        let pct = 0;
        if (typeof v === "number") {
          if (showNormalized) pct = clamp01(v / 100) * 100;
          else {
            const ext = metricExtents[param.key];
            if (ext && ext.max > ext.min) pct = clamp01((v - ext.min) / (ext.max - ext.min)) * 100;
          }
        }
        if (barEl) barEl.style.width = `${pct}%`;
      });

      const scaleModeLabel = document.getElementById("metric-scale-mode-label");
      const currentMetricLabel = document.getElementById("current-metric-label");
      const labelDef = allMetrics.find(m => m.key === currentMetric);
      currentMetricLabel.textContent = labelDef ? labelDef.label : currentMetric;
      if (showNormalized) {
        scaleModeLabel.textContent = "Normalized 0-100";
        const valNorm = props[`${currentMetric}_norm`];
        if (typeof valNorm === "number") {
          scalePointer.style.display = "block";
          scalePointer.style.left = `${clamp01(valNorm / 100) * 100}%`;
          scaleCurrent.textContent = `Position: ${formatValue(valNorm)} / 100`;
        } else { scalePointer.style.display = "none"; scaleCurrent.textContent = "No normalized value available."; }
      } else {
        scaleModeLabel.textContent = "Relative (min-max across countries)";
        const vRaw = props[`${currentMetric}_raw`];
        const ext = metricExtents[currentMetric];
        if (typeof vRaw === "number" && ext && ext.max > ext.min) {
          const pct = clamp01((vRaw - ext.min) / (ext.max - ext.min)) * 100;
          scalePointer.style.display = "block"; scalePointer.style.left = `${pct}%`;
          scaleCurrent.textContent = `Relative position: ${vRaw.toFixed(1)} (min ${ext.min.toFixed(1)} / max ${ext.max.toFixed(1)})`;
        } else { scalePointer.style.display = "none"; scaleCurrent.textContent = "No comparable raw data."; }
      }

      // Metric detail drawer content (only for parameters)
      if (detailCard && detailToggle) {
        const isParam = allParameters.some(p => p.key === currentMetric);
        const meta = paramMeta[currentMetric];
        if (isParam && meta) {
          detailDesc.textContent = meta.desc;
          detailJust.textContent = meta.just;
          detailToggle.style.display = "inline-flex";
        } else {
          detailCard.style.display = "none";
          detailToggle.style.display = "none";
          detailToggle.setAttribute("aria-expanded", "false");
        }
      }
    }

    function attachInteractions() {
      document.getElementById("control-fold-toggle").addEventListener("click", () => {
        const content = document.getElementById("control-content");
        const label = document.querySelector("#control-fold-toggle .label");
        const chev = document.querySelector("#control-fold-toggle .chevron");
        const hidden = content.style.display === "none";
        content.style.display = hidden ? "block" : "none";
        label.textContent = hidden ? "Hide" : "Show";
        chev.textContent = hidden ? "▾" : "▸";
      });
      document.querySelectorAll(".section").forEach(sec => sec.querySelector(".section-header").addEventListener("click", () => sec.classList.toggle("collapsed")));
      document.getElementById("ranking-fold-toggle").addEventListener("click", () => {
        const panel = document.getElementById("ranking-panel");
        const label = document.querySelector("#ranking-fold-toggle .label");
        const chev = document.querySelector("#ranking-fold-toggle .chevron");
        const collapsed = panel.classList.toggle("collapsed");
        label.textContent = collapsed ? "Show" : "Hide";
        chev.textContent = collapsed ? "▸" : "▾";
      });
      document.getElementById("region-fold-toggle").addEventListener("click", () => {
        const panel = document.getElementById("region-panel");
        const label = document.querySelector("#region-fold-toggle .label");
        const chev = document.querySelector("#region-fold-toggle .chevron");
        const collapsed = panel.classList.toggle("collapsed");
        label.textContent = collapsed ? "Details" : "Hide";
        chev.textContent = collapsed ? "▸" : "▾";
        document.getElementById("details-toggle").style.display = collapsed ? "block" : "none";
      });
      document.getElementById("details-toggle").addEventListener("click", () => {
        const panel = document.getElementById("region-panel");
        panel.classList.remove("collapsed");
        document.querySelector("#region-fold-toggle .label").textContent = "Hide";
        document.querySelector("#region-fold-toggle .chevron").textContent = "▾";
        document.getElementById("details-toggle").style.display = "none";
      });
      document.getElementById("toggle-normalized").addEventListener("change", e => {
        showNormalized = e.target.checked;
        ensureMetricForMode();
        rebuildViewSelect();
        buildHeatmapSelect();
        updateMap();
        updateRanking();
        if (currentCountryProps) updateRegionPanel(currentCountryProps);
      });
      document.querySelectorAll(".view-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          ensureMetricForMode();
          setViewMode(btn.dataset.view);
        });
      });
      document.querySelectorAll(".pillar-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          currentPillar = btn.dataset.pillar;
          document.querySelectorAll(".pillar-btn").forEach(b => b.classList.toggle("active", b.dataset.pillar === currentPillar));
          document.querySelectorAll(".param-panel").forEach(p => p.classList.toggle("active", p.dataset.pillar === currentPillar));
        });
      });
      document.getElementById("metric-detail-toggle").addEventListener("click", () => {
        const card = document.getElementById("metric-detail-card");
        const expanded = card.style.display === "block";
        card.style.display = expanded ? "none" : "block";
        document.getElementById("metric-detail-toggle").setAttribute("aria-expanded", (!expanded).toString());
      });
      document.getElementById("view-select").addEventListener("change", e => {
        currentMetric = e.target.value;
        const view = currentMetric.startsWith("composite_") ? "overview" : "parameter";
        setViewMode(view);
      });
    }

    function onEachFeature(feature, layer) {
      const props = feature.properties;
      countryLayerByName[props.name] = layer;
      layer.on("mouseover", () => {
        const val = props[`${currentMetric}_${showNormalized ? "norm" : "raw"}`];
        document.getElementById("hover-info").textContent = `${props.name}: ${formatValue(val)}`;
        if (showNormalized && typeof val === "number") updateLegendPointer(val);
      });
      layer.on("mouseout", () => { document.getElementById("hover-info").textContent = "Hover over a country."; });
      layer.on("click", () => { setActiveCountryLayer(layer); updateRegionPanel(props); });
    }

    function loadData() {
      fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")
        .then(r => r.json())
        .then(data => {
          data.features = data.features
            .map(f => {
              const p = f.properties || {};
              let canonical = p.ADMIN || p.admin || p.name || p.NAME || p.NAME_ENGLI || p.sovereignt || "Unknown";
              if (canonical === "Viet Nam") canonical = "Vietnam";
              if (canonical === "Czech Republic") canonical = "Czechia";
              return { ...f, properties: { ...p, name: canonical } };
            })
            .filter(f => countryNames.includes(f.properties.name));
          data.features.forEach(f => {
            const props = countryData[f.properties.name];
            if (props) f.properties = { ...f.properties, ...props };
          });
          computeMetricExtents(data);
          geoLayer = L.geoJSON(data, { style: styleCountry, onEachFeature }).addTo(map);
          if (geoLayer.getBounds().isValid()) map.fitBounds(geoLayer.getBounds(), { padding: [20, 20] });
          const firstLayer = geoLayer.getLayers()[0];
          if (firstLayer) { setActiveCountryLayer(firstLayer); updateRegionPanel(firstLayer.feature.properties); }
          updateMap(); updateRanking();
        })
        .catch(err => { console.error("Error loading GeoJSON", err); alert("Failed to load map data. Check console for details."); });
    }

    buildCriteriaUI();
    rebuildViewSelect();
    buildHeatmapSelect();
    setViewMode("overview");
    attachInteractions();
    loadData();
  </script>
</body>
</html>
